<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Mapbox 泡麵品牌評比地圖</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #brandChart {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 520px;
      height: 360px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: opacity 0.5s ease;
      opacity: 1;
    }

    #brandChart.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #brandChart canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="brandChart" class="hidden">
    <canvas></canvas>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGlla2UiLCJhIjoiY21ha3B4NzAyMDBpbTJrb3E2bHkxYmc3ciJ9.IRhRE72a7DMfw6xg5YJWtQ';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/dieke/cmauv4vve01kv01sidqof58ef',
      center: [0, 20],
      zoom: 1.5
    });

    map.on('load', async () => {
      const data = await (await fetch('Country Brand Ratings.geojson')).json();
      const sharedColor = '#6FA031';
      const radiusStops = ['interpolate', ['linear'], ['get', 'Count'], 0, 12, 500, 70];

      map.addSource('countries', { type: 'geojson', data });

      // 圓圈核心
      map.addLayer({
        id: 'bubbles-core',
        type: 'circle',
        source: 'countries',
        paint: {
          'circle-radius': radiusStops,
          'circle-color': sharedColor,
          'circle-opacity': 0.15
        }
      });

      // 外圈靜態光暈
      map.addLayer({
        id: 'bubbles-glow-static',
        type: 'circle',
        source: 'countries',
        paint: {
          'circle-radius': radiusStops,
          'circle-color': '#83B73D',
          'circle-opacity': 0.05,
          'circle-blur': 1.2
        }
      });

      // 動畫層光暈
      map.addLayer({
        id: 'bubbles-glow-anim',
        type: 'circle',
        source: 'countries',
        paint: {
          'circle-radius': radiusStops,
          'circle-color': sharedColor,
          'circle-opacity': 0.05,
          'circle-blur': 1.2
        }
      });

      ['circle-opacity', 'circle-blur'].forEach(p => {
        map.setPaintProperty('bubbles-glow-anim', `${p}-transition`, { duration: 0 });
      });

      function animate(ts) {
        const t = (ts / 1000) % 10;
        const k = (Math.sin(t * Math.PI * 2) + 1) / 2 / 10;
        const opacity = 0.4 + k * 0.2;
        const blur = 0.2 + k * 0.6;

        map.setPaintProperty('bubbles-glow-anim', 'circle-opacity', opacity);
        map.setPaintProperty('bubbles-glow-anim', 'circle-blur', blur);
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);

      function getStarColor(star) {
        const max = 5;
        const intensity = Math.min(Math.max(star / max, 0), 1);
        const baseColor = [255, 87, 34];
        const grayColor = [220, 220, 220];
        return `rgb(${grayColor.map((g, i) =>
          Math.round(g + (baseColor[i] - g) * intensity)
        ).join(',')})`;
      }

      // Popup（點擊）
      map.on('click', 'bubbles-core', e => {
        const f = e.features[0];
        const { Count, Country = 'Unknown' } = f.properties;
        const [lng, lat] = f.geometry.coordinates;
        new mapboxgl.Popup()
          .setLngLat([lng, lat])
          .setHTML(`<strong>${Country}</strong><br/>評價數量: ${Count}`)
          .addTo(map);
      });

      map.on('mouseenter', 'bubbles-core', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'bubbles-core', () => {
        map.getCanvas().style.cursor = '';
        document.querySelector('#brandChart').classList.add('hidden');  // <- 滑出時隱藏
      });

      // Bar chart 顯示
      let chart = null;
      map.on('mousemove', 'bubbles-core', e => {
        const feature = e.features[0];
        const { properties } = feature;
        const country = properties.Country || 'Unknown';

        // 如果目前已經是這個國家，就不要重繪
        if (country === currentCountry) return;
        currentCountry = country;

        let brandsData = properties.Brands;
        if (typeof brandsData === 'string') {
          try {
            brandsData = JSON.parse(brandsData);
          } catch (e) {
            return;
          }
        }

        if (!brandsData || !Array.isArray(brandsData)) return;

        const brandNames = brandsData.map(b => b.Brand);
        const brandStars = brandsData.map(b => b.Stars);

        const brandChartDiv = document.querySelector('#brandChart');
        brandChartDiv.classList.remove('hidden');  // 顯示 chart

        const canvas = brandChartDiv.querySelector('canvas');
        if (chart) chart.destroy();
        const ctx = canvas.getContext('2d');
        const colors = brandsData.map(b => getStarColor(b.Stars));

        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: brandNames,
            datasets: [{
              label: `泡麵評比 - ${country}`,
              data: brandStars,
              backgroundColor: colors
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, max: 5 },
              x: { ticks: { maxRotation: 60, minRotation: 30 } }
            },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            }
          }
        });
      });
    });

    // 滑出時要重設 currentCountry
    map.on('mouseleave', 'bubbles-core', () => {
      map.getCanvas().style.cursor = '';
      document.querySelector('#brandChart').classList.add('hidden');
      currentCountry = null;
    });
  </script>
</body>
</html>
